<html>
<head>
</head>
<body>
  <h1>The Open-Measure Knowledge Graph</h1>
  <input
         type="button"
         onclick="resetAll()"
         value="Clear">

  <!--https://select2.org/getting-started/basic-usage-->
<script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<label for="mySelect2">
  Search and select items to add to the graph.
  <select class="js-example-basic-multiple js-states form-control" id="mySelect2" multiple="multiple"  style="width: 75%">
  </select>
</label>
<div id="debugDiv">debug</div>
<div id="selectedItemDiv"></div>
<div id="mynetwork"></div>
<script type="text/javascript" src="https://unpkg.com/vis-data@latest/peer/umd/vis-data.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/vis-network@latest/peer/umd/vis-network.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://unpkg.com/vis-network/styles/vis-network.min.css" />
<script type="text/javascript">

function debug(something){
    document.getElementById("debugDiv").innerText = JSON.stringify(something);
}

var selectableItems = [
    {
      text: "Concepts",
      children: [
        {id: "n1", text: "Authentication Factors"},
        {id: "n2", text: "Inherence Factor"},
        {id: "n3", text: "Possession Factor"}
      ]
    },
    {
      text: "Processes",
      children: [
        {id: "n4", text: "Application Onboarding"},
        {id: "n5", text: "Provisioning"}
      ]
    }
  ];

var edgesDatabase = [
          { id: "e1", from: "n2", to: "n1", label:"is a", arrows:"to" },
          { id: "e2", from: "n3", to: "n1", label:"is a", arrows:"to" },
          { id: "e3", from: "n3", to: "n4", label:"is a", arrows:"to" },
          { id: "e4", from: "n4", to: "n5", label:"is a", arrows:"to" }
        ];

var nodesDatabase = [
          { id: "n1", label: "Authentication Factors", category:"Concept", url:"https://open"},
          { id: "n2", label: "Inherence Factor", category:"Concept", url:"https://open"},
          { id: "n3", label: "Possession Factor", category:"Concept", url:"https://open"},
          { id: "n4", label: "Application Onboarding", category:"Process", url:"https://open"},
          { id: "n5", label: "Provisioning", category:"Process", url:"https://open"}
        ];

$(document).ready(function() {

    $('.js-example-basic-multiple').select2({
      tags: true,
      tokenSeparators: [',', ' '],
      data: selectableItems,
      createTag: function(params) {
                return undefined;
           }
    });

    $('#mySelect2').on('select2:select', function (e) {
      var nodeId = e.params.data.id;
      document.getElementById("debugDiv").innerText = nodeId;
      loadNode(nodeId);
    });

    $('#mySelect2').on('select2:unselect', function (e) {
      var nodeId = e.params.data.id;
      document.getElementById("debugDiv").innerText = nodeId;
      unloadNode(nodeId);
    });
  });

var nodes = new vis.DataSet();
var edges = new vis.DataSet();
var network = {};

function startNetwork(){
  var container = document.getElementById("mynetwork");
        var data = {
          nodes: nodes,
          edges: edges,
        };

  var options = {
    interaction: {
      navigationButtons: true,
      keyboard: true,
    }};

    network = new vis.Network(container, data, options);

    network.on("click", function (params) {
        onClick(params);
    });
    }

startNetwork();

function onClick(params) {
    if(params.nodes.length == 1){
      /*A node was clicked*/
      var nodeId = params.nodes[0];
      var myNode = getNode(nodeId);
      document.getElementById("selectedItemDiv").innerHTML =
        '<b>' + myNode.label + '</b>' +
        '<input type="button" onclick="getMoreInformation(\'' + nodeId + '\');" value="More information" />' +
        '<input type="button" onclick="unloadNode(\'' + nodeId + '\');" value="Remove" />'
        ;
    } else if(params.edges.length == 1){
      /*An edge was clicked*/
      /*DEBUG THIS*/
      /*
      window.alert("E");
      var edgeId = params.edges[0];
      var myEdge = getEdge(edgeId);
      var label = myEdge.label;
      var from = getNode(myEdge.from);
      var to = getNode(myEdge.to);
      document.getElementById("selectedItemDiv").innerHTML =
        '<b>' + from.label + ' ' + myEdge.label + ' ' + to.label + '</b>'; /* +
        '<input type="button" onclick="getMoreInformation(\'' + nodeId + '\');" value="More information" />' +
        '<input type="button" onclick="unloadNode(\'' + nodeId + '\');" value="Remove" />'
        */
    }

  }

function resetAll() {
  $('#mySelect2').val(null).trigger('change');
  nodes.clear();
  edges.clear();
}

function getEdge(edgeId){
  var result = edgesDatabase.filter(obj => {
    return obj.id === nodeId
    });
  return result[0];
}

function getNode(nodeId){
  var result = nodesDatabase.filter(obj => {
    return obj.id === nodeId
    });
  return result[0];
}

function loadAdjacent(nodeId){
  for (i = 0; i < edgesDatabase.length; i++) {
    myEdge = edgesDatabase[i];
    if(myEdge.from == nodeId || myEdge.to == nodeId){
      edges.update(myEdge);
      nodes.update(getNode(myEdge.from));
      nodes.update(getNode(myEdge.to));
    }
  }
}

function loadNode(nodeId){
  var targetNode = getNode(nodeId);
  nodes.update(targetNode);
  loadAdjacent(nodeId);
}

function getMoreInformation(nodeId){
  var targetNode = getNode(nodeId);
  window.open(targetNode.url, "_blank");
}

function noSelection(){
  document.getElementById("selectedItemDiv").innerHTML = "<i>No item selected</i>";
}
noSelection();

function unloadNode(nodeId){
  nodes.remove(nodeId);
  noSelection();
}

</script>
</body>
</html>
